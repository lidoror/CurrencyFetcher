name: CurrencyFetcherBuild

trigger:
    branches:
        include:
            - main
variables:
    REPOSITORY_NAME: currency_fetcher

    
stages:
    - stage: Build
      jobs:
          - job: BuildAndPushImage
            pool: Azure Pipelines
            steps:
                            
            - task: Bash@3
              displayName: CreatingTag
              inputs:
                targetType: 'inline'
                script: |
                    GIT_COMMIT=$(git rev-parse --short HEAD)
                    echo "GIT_COMMIT: ${GIT_COMMIT}"
                    echo "##vso[task.setvariable variable=GIT_COMMIT]${GIT_COMMIT}"

            - script: docker build -f  infra/Docker/CurrencyFetcher.Dockerfile -t $(REPOSITORY_NAME):$(GIT_COMMIT) .
              displayName: BuildImage
              
            - task: ECRPushImage@1
              inputs:
                awsCredentials: $(connection_name)
                regionName: $(region)
                imageSource: 'imagename'
                sourceImageName: '$(REPOSITORY_NAME):$(GIT_COMMIT)'
                sourceImageTag: '$(GIT_COMMIT)'
                repositoryName: '$(REPOSITORY_NAME)'
                pushTag: '$(GIT_COMMIT)'
          
          
          - job: GitTea
            pool: Docker
            

